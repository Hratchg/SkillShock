<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SkillShock — Career Intelligence</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
:root{
  --bg:        #0b0b0b;
  --bg2:       #111111;
  --surface:   #161616;
  --surface2:  #1c1c1c;
  --border:    #242424;
  --border2:   #303030;
  --text1:     #f4f4f4;
  --text2:     #8a8a8a;
  --text3:     #484848;
  --gold:      #c9a96e;
  --gold2:     #e8c98a;
  --gold-dim:  #6b5535;
  --glow:      rgba(201,169,110,0.15);
  --r:         12px;
  --rsm:       8px;
}
body{
  background:var(--bg);color:var(--text1);
  font-family:'Inter',sans-serif;
  -webkit-font-smoothing:antialiased;
  min-height:100vh;overflow-x:hidden;
}

/* ── Loader ── */
#loader{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:9999;transition:opacity .6s ease;
}
#loader.fade{opacity:0;pointer-events:none;}
.l-hex{animation:lbreathe 2s ease-in-out infinite;}
@keyframes lbreathe{
  0%,100%{transform:scale(1) rotate(0deg);filter:drop-shadow(0 0 16px rgba(201,169,110,.5));}
  50%{transform:scale(.88) rotate(3deg);filter:drop-shadow(0 0 32px rgba(201,169,110,.8));}
}
.l-name{
  margin-top:20px;font-size:22px;font-weight:600;letter-spacing:-.02em;
  color:var(--gold);
}
.l-tag{
  margin-top:6px;font-size:11px;font-weight:500;letter-spacing:.2em;
  text-transform:uppercase;color:var(--text3);
}
.l-tag::after{content:'';animation:ldots 1.6s steps(4,end) infinite;}
@keyframes ldots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}

/* ── Hero header ── */
.hero{
  position:relative;overflow:hidden;
  padding:0 72px;
  min-height:160px;
  background:var(--bg);
  border-bottom:1px solid var(--border);
}
.hero-inner{
  display:flex;align-items:center;justify-content:space-between;
  padding:48px 0 44px;gap:40px;
  position:relative;z-index:1;
}
.hero-left{display:flex;align-items:center;gap:24px;}
.hero-logo-wrap{position:relative;flex-shrink:0;}
.hero-text{}
.hero-name{
  font-size:36px;font-weight:700;letter-spacing:-.03em;line-height:1;
  color:var(--text1);
}
.hero-sub{
  margin-top:8px;font-size:12px;font-weight:500;letter-spacing:.16em;
  text-transform:uppercase;color:var(--text3);
}
.hero-right{display:flex;flex-direction:column;align-items:flex-end;gap:16px;}
.hero-pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.hero-pill{
  font-size:11px;font-weight:500;letter-spacing:.06em;
  padding:6px 14px;border-radius:999px;
  border:1px solid var(--border2);
  color:var(--text2);background:var(--surface);
  white-space:nowrap;
}
.hero-pill.accent{
  color:var(--gold);
  border-color:rgba(201,169,110,.35);
  background:rgba(201,169,110,.08);
}

/* ── Stat strip inside hero ── */
.stat-strip{
  display:flex;
  border-top:1px solid var(--border);
  margin:0 -72px;padding:0 72px;
  background:var(--bg2);
  position:relative;z-index:1;
}
.stat-item{
  flex:1;padding:32px 36px;
  border-right:1px solid var(--border);
  transition:background .2s;cursor:default;
}
.stat-item:last-child{border-right:none;}
.stat-item:hover{background:rgba(201,169,110,.03);}
.stat-n{
  font-size:26px;font-weight:600;letter-spacing:-.03em;
  color:var(--text1);line-height:1;margin-bottom:8px;
}
.stat-l{
  font-size:10px;font-weight:500;letter-spacing:.12em;
  text-transform:uppercase;color:var(--text3);
}

/* ── Nav / tabbar ── */
.tabbar{
  position:sticky;top:0;z-index:100;
  display:flex;align-items:stretch;
  background:rgba(11,11,11,.94);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  padding:0 72px;
  overflow-x:auto;
}
.tabbar::-webkit-scrollbar{display:none;}
.tab-btn{
  flex-shrink:0;height:48px;
  padding:0 4px;margin-right:32px;
  font-size:13px;font-weight:400;color:var(--text3);
  background:none;border:none;
  border-bottom:1.5px solid transparent;
  cursor:pointer;
  transition:color .2s,border-color .2s;
  white-space:nowrap;
}
.tab-btn:hover{color:var(--text2);}
.tab-btn.active{color:var(--text1);border-bottom-color:var(--gold);font-weight:500;}

/* ── Panels ── */
.panel{display:none;animation:fadein .3s ease both;}
.panel.active{display:block;}
@keyframes fadein{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

/* ── Overview panel ── */
.ov-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:1px;background:var(--border);
  border-top:1px solid var(--border);border-bottom:1px solid var(--border);
}
.ov-card{
  background:var(--bg);padding:52px 60px;
  position:relative;overflow:hidden;transition:background .25s;
}
.ov-card:hover{background:var(--bg2);}
.ov-card-label{font-size:10px;font-weight:500;letter-spacing:.16em;text-transform:uppercase;color:var(--text3);margin-bottom:20px;}
.ov-card-title{font-size:22px;font-weight:600;letter-spacing:-.02em;color:var(--text1);margin-bottom:12px;line-height:1.2;}
.ov-card-desc{font-size:13px;color:var(--text2);line-height:1.7;max-width:480px;}
.ov-card-nums{display:flex;gap:48px;margin-top:36px;}
.ov-num{display:flex;flex-direction:column;gap:6px;}
.ov-num-val{font-size:34px;font-weight:700;letter-spacing:-.04em;color:var(--text1);line-height:1;}
.ov-num-lbl{font-size:10px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);}
.ov-card-accent{
  position:absolute;top:0;left:0;right:0;height:1.5px;
  background:var(--gold);opacity:0;transition:opacity .25s;
}
.ov-card:hover .ov-card-accent{opacity:.4;}

/* ── Section header ── */
.sec-head{
  display:flex;align-items:flex-end;justify-content:space-between;
  padding:52px 72px 0;margin-bottom:36px;
}
.sec-eyebrow{font-size:10px;font-weight:500;letter-spacing:.18em;text-transform:uppercase;color:var(--gold);margin-bottom:10px;}
.sec-title{font-size:30px;font-weight:700;letter-spacing:-.025em;color:var(--text1);line-height:1.1;}
.sec-desc{font-size:13px;color:var(--text2);line-height:1.6;max-width:500px;margin-top:10px;}

/* ── Controls ── */
.controls{display:flex;gap:14px;align-items:flex-end;padding:0 72px 32px;}
.field{display:flex;flex-direction:column;gap:7px;}
.field label{font-size:10px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);}
.field input,.field select,.field textarea{
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--rsm);
  color:var(--text1);font-family:inherit;font-size:13px;
  padding:10px 14px;outline:none;
  transition:border-color .18s,box-shadow .18s;min-width:200px;
  -webkit-appearance:none;appearance:none;
}
.field input:focus,.field select:focus,.field textarea:focus{
  border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,169,110,.1);
}
.field select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23484848' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;
  padding-right:36px;cursor:pointer;
}
.field select option{background:#1c1c1c;}
.field.wide{flex:1;}
.field.wide select,.field.wide input{width:100%;}
.field textarea{resize:vertical;min-height:72px;line-height:1.5;}

/* ── Chart panel ── */
.chart-panel{
  margin:0 72px 64px;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--r);
  overflow:hidden;position:relative;
}
.chart-panel::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,#7c3aed,#06b6d4,#c9a96e);opacity:.5;
}
.chart-inner{width:100%;min-height:420px;}
.chart-loading{
  display:flex;align-items:center;justify-content:center;
  min-height:420px;flex-direction:column;gap:14px;
  color:var(--text3);font-size:11px;letter-spacing:.12em;text-transform:uppercase;
}
.chart-loading-hex{width:32px;height:32px;animation:lbreathe 1.8s ease-in-out infinite;opacity:.4;}

/* ── Paths panel ── */
.paths-panel{
  margin:0 72px 64px;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--r);
  overflow:hidden;position:relative;
}
.paths-panel::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,#7c3aed,#06b6d4,#c9a96e);opacity:.5;
}
.paths-header{
  display:flex;align-items:center;padding:20px 32px 18px;
  border-bottom:1px solid var(--border);background:var(--surface2);
}
.paths-header span{font-size:10px;font-weight:500;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);}
.paths-header .ph-r{margin-left:auto;}
.path-row{
  display:flex;align-items:center;gap:20px;
  padding:26px 32px;border-bottom:1px solid var(--border);
  transition:background .18s;cursor:default;
}
.path-row:hover{background:rgba(201,169,110,.03);}
.path-row:last-child{border-bottom:none;}
.path-idx{
  width:28px;height:28px;border-radius:50%;
  background:rgba(201,169,110,.08);border:1px solid rgba(201,169,110,.2);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:600;color:var(--gold);flex-shrink:0;
}
.path-chips{display:flex;align-items:center;flex-wrap:wrap;gap:6px;flex:1;}
.chip{
  background:rgba(255,255,255,.05);border:1px solid var(--border2);
  border-radius:6px;padding:6px 14px;font-size:13px;color:var(--text1);white-space:nowrap;
  transition:border-color .18s,background .18s;
}
.path-row:hover .chip{border-color:rgba(201,169,110,.2);background:rgba(201,169,110,.04);}
.chip-arr{color:var(--text3);font-size:13px;margin:0 2px;}
.path-vol{font-size:12px;font-weight:500;color:var(--gold);flex-shrink:0;min-width:80px;text-align:right;font-variant-numeric:tabular-nums;}

/* ── AI Planner styles ── */
.planner-layout{
  display:grid;grid-template-columns:320px 1fr;gap:0;
  border-top:1px solid var(--border);min-height:calc(100vh - 200px);
}
.planner-form{
  background:var(--bg2);border-right:1px solid var(--border);
  padding:36px 28px;overflow-y:auto;
  display:flex;flex-direction:column;gap:28px;
}
.planner-output{
  padding:0;overflow:hidden;
  display:flex;flex-direction:column;
}
.form-section-label{
  font-size:10px;font-weight:600;letter-spacing:.18em;text-transform:uppercase;
  color:var(--gold);margin-bottom:14px;padding-bottom:10px;
  border-bottom:1px solid var(--border);
}
.form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.form-group label{font-size:10px;font-weight:500;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);}
.form-group input,.form-group select,.form-group textarea{
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--rsm);
  color:var(--text1);font-family:inherit;font-size:12px;padding:9px 12px;outline:none;
  transition:border-color .18s,box-shadow .18s;width:100%;
  -webkit-appearance:none;appearance:none;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  border-color:var(--gold);box-shadow:0 0 0 2px rgba(201,169,110,.1);
}
.form-group select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23484848' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
  padding-right:28px;cursor:pointer;
}
.form-group select option{background:#1c1c1c;}
.form-group textarea{resize:vertical;min-height:60px;line-height:1.5;}
.slider-wrap{display:flex;flex-direction:column;gap:6px;}
.slider-wrap input[type=range]{
  width:100%;accent-color:var(--gold);height:3px;cursor:pointer;
}
.slider-val{font-size:11px;color:var(--gold);font-weight:500;text-align:right;}
.radio-group{display:flex;flex-direction:column;gap:7px;}
.radio-item{display:flex;align-items:center;gap:9px;cursor:pointer;}
.radio-item input[type=radio]{accent-color:var(--gold);width:13px;height:13px;cursor:pointer;}
.radio-item span{font-size:12px;color:var(--text2);}

.generate-btn{
  width:100%;padding:14px;
  background:var(--gold);color:#0b0b0b;
  border:none;border-radius:var(--rsm);
  font-family:inherit;font-size:13px;font-weight:600;
  cursor:pointer;letter-spacing:.03em;
  transition:opacity .18s,transform .1s;
  margin-top:8px;
}
.generate-btn:hover{opacity:.88;}
.generate-btn:active{transform:scale(.98);}
.generate-btn:disabled{opacity:.4;cursor:not-allowed;}

/* Plan output area */
.plan-status-bar{
  display:flex;align-items:center;gap:12px;
  padding:16px 32px;background:var(--surface2);
  border-bottom:1px solid var(--border);
  font-size:11px;color:var(--text3);letter-spacing:.08em;
  min-height:48px;
}
.status-dot{
  width:7px;height:7px;border-radius:50%;background:var(--text3);flex-shrink:0;
}
.status-dot.active{background:var(--gold);animation:dotpulse 1.2s ease-in-out infinite;}
.status-dot.done{background:#4caf50;}
.status-dot.error{background:#f44;}
@keyframes dotpulse{0%,100%{opacity:1;}50%{opacity:.3;}}

.plan-tabs{
  display:flex;border-bottom:1px solid var(--border);
  background:var(--surface);padding:0 32px;overflow-x:auto;
}
.plan-tabs::-webkit-scrollbar{display:none;}
.plan-tab{
  flex-shrink:0;height:42px;padding:0 4px;margin-right:24px;
  font-size:12px;font-weight:400;color:var(--text3);
  background:none;border:none;border-bottom:1.5px solid transparent;
  cursor:pointer;transition:color .18s,border-color .18s;white-space:nowrap;
}
.plan-tab:hover{color:var(--text2);}
.plan-tab.active{color:var(--text1);border-bottom-color:var(--gold);font-weight:500;}

.plan-pane{display:none;flex:1;overflow:auto;}
.plan-pane.active{display:flex;flex-direction:column;}

/* Plan markdown rendered */
.plan-md{
  padding:36px 40px;font-size:13px;line-height:1.75;color:var(--text2);
  flex:1;
}
.plan-md h1{font-size:22px;font-weight:700;color:var(--text1);margin-bottom:8px;letter-spacing:-.02em;}
.plan-md h2{font-size:15px;font-weight:600;color:var(--gold);margin:28px 0 10px;letter-spacing:.02em;text-transform:uppercase;font-size:10px;}
.plan-md h3{font-size:14px;font-weight:600;color:var(--text1);margin:18px 0 6px;}
.plan-md p{margin-bottom:12px;}
.plan-md ul,.plan-md ol{padding-left:20px;margin-bottom:12px;}
.plan-md li{margin-bottom:5px;}
.plan-md strong{color:var(--text1);font-weight:600;}
.plan-md em{color:var(--text2);font-style:italic;}
.plan-md code{
  background:var(--surface2);border:1px solid var(--border2);
  border-radius:4px;padding:2px 7px;font-size:11px;color:var(--gold);
}
.plan-md blockquote{
  border-left:2px solid var(--gold);padding-left:16px;color:var(--text2);
  margin:16px 0;font-style:italic;
}
.plan-md hr{border:none;border-top:1px solid var(--border);margin:24px 0;}

/* Data charts pane */
.plan-charts{padding:28px 32px;display:grid;grid-template-columns:1fr 1fr;gap:24px;flex:1;}
.plan-chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.plan-chart-card.full{grid-column:1/-1;}
.plan-chart-header{padding:14px 20px;border-bottom:1px solid var(--border);background:var(--surface2);}
.plan-chart-title{font-size:10px;font-weight:500;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);}
.plan-chart-inner{width:100%;min-height:280px;}

/* Paths in plan pane */
.plan-paths{padding:28px 32px;flex:1;}
.plan-path-row{
  display:flex;align-items:center;gap:16px;
  padding:20px 24px;border:1px solid var(--border);border-radius:var(--rsm);
  margin-bottom:10px;background:var(--surface);transition:border-color .18s;
}
.plan-path-row:hover{border-color:rgba(201,169,110,.25);}
.plan-path-idx{
  width:24px;height:24px;border-radius:50%;
  background:rgba(201,169,110,.08);border:1px solid rgba(201,169,110,.2);
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:600;color:var(--gold);flex-shrink:0;
}
.plan-path-chips{display:flex;align-items:center;flex-wrap:wrap;gap:5px;flex:1;}
.plan-path-vol{font-size:11px;color:var(--gold);flex-shrink:0;}

/* Export row */
.export-row{
  display:flex;gap:12px;align-items:center;
  padding:20px 32px;border-top:1px solid var(--border);
  background:var(--surface2);
}
.export-btn{
  display:flex;align-items:center;gap:7px;
  padding:10px 18px;border-radius:var(--rsm);
  font-family:inherit;font-size:12px;font-weight:500;
  cursor:pointer;transition:opacity .18s;border:1px solid var(--border2);
  color:var(--text2);background:var(--surface);
  letter-spacing:.03em;
}
.export-btn:hover{border-color:var(--gold);color:var(--gold);opacity:.9;}
.export-btn:disabled{opacity:.3;cursor:not-allowed;}
.export-note{font-size:11px;color:var(--text3);margin-left:auto;}

/* Gantt timeline */
.timeline-pane{flex:1;padding:28px 32px;}

/* Scrollbar */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--gold-dim);}
</style>
</head>
<body>

<!-- ── Loader ── -->
<div id="loader">
  <svg class="l-hex" width="72" height="72" viewBox="0 0 40 40" fill="none">
    <path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="#c9a96e" fill-opacity="0.1"/>
    <path d="M20 3 L35 11.5 L35 20 L20 20 L5 20 L5 11.5 Z" fill="#c9a96e" opacity="0.2"/>
    <line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6"/>
    <line x1="20" y1="3" x2="5" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity="0.55"/>
    <line x1="20" y1="37" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity="0.55"/>
  </svg>
  <div class="l-name">SkillShock</div>
  <div class="l-tag">Loading</div>
</div>

<!-- ── Hero Header ── -->
<header class="hero">
  <div class="hero-inner">
    <div class="hero-left">
      <div class="hero-logo-wrap">
        <svg width="72" height="72" viewBox="0 0 40 40" fill="none">
          <path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="#c9a96e" fill-opacity="0.1"/>
          <path d="M20 3 L35 11.5 L35 20 L20 20 L5 20 L5 11.5 Z" fill="#c9a96e" opacity="0.22"/>
          <line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6"/>
          <line x1="20" y1="3" x2="5" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity="0.55"/>
          <line x1="20" y1="37" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity="0.55"/>
        </svg>
      </div>
      <div class="hero-text">
        <div class="hero-name">SkillShock</div>
        <div class="hero-sub">Career Intelligence Platform</div>
      </div>
    </div>
    <div class="hero-right">
      <div class="hero-pills">
        <span class="hero-pill accent" id="pill-persons">— profiles</span>
        <span class="hero-pill" id="pill-date">—</span>
        <span class="hero-pill accent">Live Data Technologies</span>
      </div>
    </div>
  </div>
  <div class="stat-strip" id="stat-strip"></div>
</header>

<!-- ── Tab Bar ── -->
<div class="tabbar">
  <button class="tab-btn active" data-tab="overview">Overview</button>
  <button class="tab-btn" data-tab="promo">Promotion Velocity</button>
  <button class="tab-btn" data-tab="roles">Role Transitions</button>
  <button class="tab-btn" data-tab="major">Major → First Role</button>
  <button class="tab-btn" data-tab="industry">Industry Transitions</button>
  <button class="tab-btn" data-tab="paths">Career Paths</button>
  <button class="tab-btn" data-tab="flow">Career Flow</button>
  <button class="tab-btn" data-tab="planner">AI Career Planner</button>
</div>

<!-- ── Overview ── -->
<div class="panel active" id="tab-overview">
  <div class="ov-grid" id="ov-grid"></div>
</div>

<!-- ── Promotion Velocity ── -->
<div class="panel" id="tab-promo">
  <div class="sec-head">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Insight · Promotion Velocity</div>
      <div class="sec-title">How fast do careers advance?</div>
      <div class="sec-desc">Median months between career level transitions — visualized as a lollipop chart. Cyan markers are high-confidence; muted markers have small sample sizes.</div>
    </div>
  </div>
  <div class="chart-panel">
    <div class="chart-inner chart-loading" id="chart-promo">
      <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>
      Loading
    </div>
  </div>
</div>

<!-- ── Role Transitions ── -->
<div class="panel" id="tab-roles">
  <div class="sec-head">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Explorer · Role Transitions</div>
      <div class="sec-title">Where do people go next?</div>
      <div class="sec-desc">Probability-weighted horizontal bars. Brighter = more likely destination. Select a source role to see the ten most common next moves.</div>
    </div>
  </div>
  <div class="controls">
    <div class="field"><label>Search Roles</label><input type="text" id="role-search" placeholder="e.g. Software Engineer…"/></div>
    <div class="field wide"><label>Source Role</label><select id="role-select"></select></div>
  </div>
  <div class="chart-panel">
    <div class="chart-inner chart-loading" id="chart-role">
      <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>
      Loading
    </div>
  </div>
</div>

<!-- ── Major → First Role ── -->
<div class="panel" id="tab-major">
  <div class="sec-head">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Explorer · Major to First Role</div>
      <div class="sec-title">Where does your degree take you?</div>
      <div class="sec-desc">Funnel chart showing graduation-to-career probability. Each bar represents how often graduates land that specific first role.</div>
    </div>
  </div>
  <div class="controls">
    <div class="field"><label>Search Majors</label><input type="text" id="major-search" placeholder="e.g. Computer Science…"/></div>
    <div class="field wide"><label>Major / Field of Study</label><select id="major-select"></select></div>
  </div>
  <div class="chart-panel">
    <div class="chart-inner chart-loading" id="chart-major">
      <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>
      Loading
    </div>
  </div>
</div>

<!-- ── Industry Transitions ── -->
<div class="panel" id="tab-industry">
  <div class="sec-head">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Explorer · Industry Transitions</div>
      <div class="sec-title">Which industries do people move to?</div>
      <div class="sec-desc">Donut chart showing probability distribution across destination industries. Hover for details.</div>
    </div>
  </div>
  <div class="controls">
    <div class="field"><label>Search Industries</label><input type="text" id="ind-search" placeholder="e.g. Technology…"/></div>
    <div class="field wide"><label>Source Industry</label><select id="ind-select"></select></div>
  </div>
  <div class="chart-panel">
    <div class="chart-inner chart-loading" id="chart-ind">
      <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>
      Loading
    </div>
  </div>
</div>

<!-- ── Career Paths ── -->
<div class="panel" id="tab-paths">
  <div class="sec-head">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Explorer · Career Paths</div>
      <div class="sec-title">What roads lead here?</div>
      <div class="sec-desc">The five most common sequences of roles that professionals followed to reach a chosen target position.</div>
    </div>
  </div>
  <div class="controls">
    <div class="field"><label>Search Roles</label><input type="text" id="path-search" placeholder="e.g. Director…"/></div>
    <div class="field wide"><label>Target Role</label><select id="path-select"></select></div>
  </div>
  <div class="paths-panel">
    <div class="paths-header"><span>Career Path</span><span class="ph-r">People</span></div>
    <div id="paths-list"></div>
  </div>
</div>

<!-- ── Career Flow (Sankey) ── -->
<div class="panel" id="tab-flow">
  <div class="sec-head">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Insight · Career Flow</div>
      <div class="sec-title">How do careers branch out?</div>
      <div class="sec-desc">Sankey diagrams visualizing the flow from majors to first roles and between industries. Line thickness reflects transition volume.</div>
    </div>
  </div>
  <div class="controls">
    <div class="field"><label>Search Majors</label><input type="text" id="flow-major-search" placeholder="e.g. Computer Science…"/></div>
    <div class="field wide"><label>Major (blank = overview)</label><select id="flow-major-select"><option value="">All Majors (Overview)</option></select></div>
  </div>
  <div class="chart-panel">
    <div class="chart-inner chart-loading" id="chart-sankey-major">
      <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>
      Loading
    </div>
  </div>
  <div class="sec-head" style="margin-top:16px;">
    <div class="sec-head-left">
      <div class="sec-eyebrow">Insight · Industry Transfers</div>
      <div class="sec-title">Cross-industry migration patterns</div>
      <div class="sec-desc">Which industries feed into each other? Top 10 source industries and their most common destinations.</div>
    </div>
  </div>
  <div class="chart-panel">
    <div class="chart-inner chart-loading" id="chart-sankey-industry">
      <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>
      Loading
    </div>
  </div>
</div>

<!-- ── AI Career Planner ── -->
<div class="panel" id="tab-planner">
  <div class="planner-layout">

    <!-- Left: form -->
    <div class="planner-form">

      <div>
        <div class="form-section-label">Academic Background</div>
        <div class="form-group">
          <label>Field of Study / Major</label>
          <select id="ai-major"></select>
        </div>
        <div class="form-group">
          <label>GPA / Academic Standing (optional)</label>
          <input type="text" id="ai-gpa" placeholder="e.g. 3.7 / 4.0, Dean's List"/>
        </div>
        <div class="form-group">
          <label>Months Until Graduation / Next Transition</label>
          <div class="slider-wrap">
            <input type="range" id="ai-months" min="1" max="48" value="12" oninput="document.getElementById('ai-months-val').textContent=this.value+' months'"/>
            <div class="slider-val" id="ai-months-val">12 months</div>
          </div>
        </div>
      </div>

      <div>
        <div class="form-section-label">Work Experience</div>
        <div class="form-group">
          <label>Years of Work Experience</label>
          <div class="slider-wrap">
            <input type="range" id="ai-years" min="0" max="30" value="0" oninput="document.getElementById('ai-years-val').textContent=this.value+' years'"/>
            <div class="slider-val" id="ai-years-val">0 years</div>
          </div>
        </div>
        <div class="form-group">
          <label>Current or Most Recent Role</label>
          <select id="ai-current-role"></select>
        </div>
        <div class="form-group">
          <label>Current Industry</label>
          <select id="ai-current-industry"></select>
        </div>
        <div class="form-group">
          <label>Internships / Projects / Relevant Experience</label>
          <textarea id="ai-internships" placeholder="e.g. SWE intern at fintech startup, ML project, research assistant"></textarea>
        </div>
      </div>

      <div>
        <div class="form-section-label">Career Goals</div>
        <div class="form-group">
          <label>Target / Dream Role</label>
          <select id="ai-target-role"></select>
        </div>
        <div class="form-group">
          <label>Salary Expectations (optional)</label>
          <input type="text" id="ai-salary" placeholder="e.g. $100k year 1, $150k within 3 years"/>
        </div>
        <div class="form-group">
          <label>Timeline Urgency</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="urgency" value="Exploring options"/><span>Exploring options</span></label>
            <label class="radio-item"><input type="radio" name="urgency" value="Actively planning" checked/><span>Actively planning</span></label>
            <label class="radio-item"><input type="radio" name="urgency" value="Urgent — need a job ASAP"/><span>Urgent — need a job ASAP</span></label>
          </div>
        </div>
      </div>

      <div>
        <div class="form-section-label">Skills &amp; Preferences</div>
        <div class="form-group">
          <label>Current Skills &amp; Tools</label>
          <textarea id="ai-skills" placeholder="e.g. Python, SQL, Excel, Figma, React, public speaking"></textarea>
        </div>
        <div class="form-group">
          <label>Geographic Preference (optional)</label>
          <input type="text" id="ai-location" placeholder="e.g. New York City, remote only, open to relocation"/>
        </div>
        <div class="form-group">
          <label>Work Style Preference</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="work_style" value="Startup / fast-paced"/><span>Startup / fast-paced</span></label>
            <label class="radio-item"><input type="radio" name="work_style" value="Large company / structured"/><span>Large company / structured</span></label>
            <label class="radio-item"><input type="radio" name="work_style" value="No preference" checked/><span>No preference</span></label>
          </div>
        </div>
      </div>

      <div>
        <div class="form-section-label">Anything Else?</div>
        <div class="form-group">
          <label>Constraints / Special Circumstances</label>
          <textarea id="ai-constraints" placeholder="e.g. visa sponsorship needed, career switching, returning from gap year"></textarea>
        </div>
        <div class="form-group">
          <label>Additional Context</label>
          <textarea id="ai-extra" placeholder="Anything else to personalize your plan..."></textarea>
        </div>
      </div>

      <button class="generate-btn" id="generate-btn" onclick="generatePlan()">
        Generate My Career Plan
      </button>
    </div>

    <!-- Right: output -->
    <div class="planner-output">
      <div class="plan-status-bar">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Complete the form and click Generate to receive your personalized career roadmap.</span>
      </div>

      <div class="plan-tabs">
        <button class="plan-tab active" data-ptab="roadmap">Roadmap</button>
        <button class="plan-tab" data-ptab="data-charts">Data Charts</button>
        <button class="plan-tab" data-ptab="career-paths">Career Paths</button>
        <button class="plan-tab" data-ptab="timeline">Timeline</button>
      </div>

      <!-- Roadmap pane -->
      <div class="plan-pane active" id="ptab-roadmap">
        <div class="plan-md" id="plan-md-content">
          <p style="color:var(--text3);font-size:13px;margin-top:20px;">
            Fill in your profile on the left and click <strong style="color:var(--text1)">Generate My Career Plan</strong>.<br/>
            The AI advisor matches your situation against <strong style="color:var(--gold)">75,000+ real career trajectories</strong> and produces a month-by-month roadmap backed by real data.
          </p>
        </div>
      </div>

      <!-- Data charts pane -->
      <div class="plan-pane" id="ptab-data-charts">
        <div class="plan-charts">
          <div class="plan-chart-card">
            <div class="plan-chart-header"><div class="plan-chart-title">Where people go from your current role</div></div>
            <div class="plan-chart-inner chart-loading" id="plan-chart-role">
              <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/></svg>
              Waiting for plan
            </div>
          </div>
          <div class="plan-chart-card">
            <div class="plan-chart-header"><div class="plan-chart-title">First jobs for your major</div></div>
            <div class="plan-chart-inner chart-loading" id="plan-chart-major">
              <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/></svg>
              Waiting for plan
            </div>
          </div>
          <div class="plan-chart-card">
            <div class="plan-chart-header"><div class="plan-chart-title">Industry switch paths</div></div>
            <div class="plan-chart-inner chart-loading" id="plan-chart-industry">
              <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/></svg>
              Waiting for plan
            </div>
          </div>
          <div class="plan-chart-card">
            <div class="plan-chart-header"><div class="plan-chart-title">Promotion velocity — relevant transitions highlighted</div></div>
            <div class="plan-chart-inner chart-loading" id="plan-chart-promo">
              <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/></svg>
              Waiting for plan
            </div>
          </div>
        </div>
      </div>

      <!-- Career paths pane -->
      <div class="plan-pane" id="ptab-career-paths">
        <div class="plan-paths" id="plan-paths-content">
          <p style="color:var(--text3);font-size:13px;">Career path data will appear here after you generate your plan.</p>
        </div>
      </div>

      <!-- Timeline pane -->
      <div class="plan-pane" id="ptab-timeline">
        <div class="timeline-pane">
          <div class="plan-chart-inner chart-loading" id="plan-chart-timeline" style="min-height:400px;">
            <svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/></svg>
            Waiting for plan
          </div>
        </div>
      </div>

      <!-- Export row -->
      <div class="export-row">
        <button class="export-btn" id="btn-pdf" disabled onclick="exportPDF()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Download PDF
        </button>
        <button class="export-btn" id="btn-ics" disabled onclick="exportICS()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Add to Calendar
        </button>
        <span class="export-note">Powered by Gemini 2.5 Flash · Requires GOOGLE_API_KEY in .env</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════
   CHART PALETTE SYSTEM — vivid multi-hue against dark bg
   ══════════════════════════════════════════════════════════════ */
const BG      = '#161616';
const SURFACE = '#0b0b0b';
const TEXT1   = '#f4f4f4';
const TEXT2   = '#8a8a8a';
const TEXT3   = '#404040';
const GRID    = '#1e1e1e';
const GOLD    = '#c9a96e';
const GOLDDIM = '#3a3020';

/* Per-chart vivid palettes */
const PAL = {
  // Cyan → Violet gradient for role transitions (probability ranked)
  role: [
    '#06b6d4','#0ea5e9','#3b82f6','#6366f1','#8b5cf6',
    '#a78bfa','#7c3aed','#6d28d9','#5b21b6','#4c1d95'
  ],
  // Warm amber-to-rose for major→first role
  major: [
    '#fbbf24','#f59e0b','#f97316','#ef4444','#ec4899',
    '#db2777','#be185d','#9d174d','#831843','#6d1a3a'
  ],
  // Teal-to-green spectrum for industry donut
  industry: [
    '#14b8a6','#10b981','#22c55e','#84cc16','#eab308',
    '#f97316','#ef4444','#f43f5e','#a855f7','#06b6d4'
  ],
  // Electric cyan for promo lollipop (high conf) / dim for low
  promoHigh: '#00e5ff',
  promoDim:  '#1e3a3a',
  // Timeline / Gantt category colors
  gantt: {
    'Skills':      '#06b6d4',
    'Networking':  '#a855f7',
    'Applications':'#f59e0b',
    'Experience':  '#22c55e',
    'Education':   '#3b82f6',
    'Career Move': '#f43f5e',
  },
  // Plan sub-charts
  planRole:  ['#00e5ff','#06b6d4','#0891b2','#0e7490','#155e75','#164e63','#083344','#042f2e','#022c22','#011a10'],
  planMajor: ['#fbbf24','#f59e0b','#f97316','#ea580c','#c2410c','#9a3412','#7c2d12','#6c2d0d','#5a1f09','#461206'],
  planInd:   ['#a855f7','#9333ea','#7c3aed','#6d28d9','#5b21b6','#4c1d95','#3b1470','#2d0f55','#200b3d','#150826'],
};

const CFG = { displayModeBar: false, responsive: true };

const BASE_LAYOUT = {
  paper_bgcolor: BG, plot_bgcolor: BG,
  font: { family:"'Inter',sans-serif", color: TEXT2, size: 12 },
  margin: { l:8, r:110, t:32, b:44 },
  xaxis: { gridcolor: GRID, zeroline: false, color: TEXT3, tickfont:{size:11}, linecolor: GRID },
  yaxis: { gridcolor:'rgba(0,0,0,0)', zeroline: false, color: TEXT1, tickfont:{size:13}, showgrid: false, automargin: true },
  showlegend: false,
  bargap: 0.38,
};

/* ── Counter animation ── */
function animateCount(el, target) {
  const num = parseInt(target.replace(/,/g,''), 10);
  if (isNaN(num)) { el.textContent = target; return; }
  let i=0; const steps=Math.ceil(900/16);
  const t = setInterval(()=>{
    i++; const e=1-Math.pow(1-i/steps,3);
    el.textContent = Math.round(e*num).toLocaleString();
    if(i>=steps){el.textContent=target;clearInterval(t);}
  },16);
}

/* ── Filter helper ── */
function filterSelect(sel, all, q) {
  q = q.trim().toLowerCase();
  const filt = q
    ? [...all.filter(o=>o.toLowerCase().startsWith(q)),
       ...all.filter(o=>!o.toLowerCase().startsWith(q)&&o.toLowerCase().includes(q))]
    : all;
  const prev = sel.value;
  sel.innerHTML = filt.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');
  if(filt.includes(prev)) sel.value = prev;
  return sel.value;
}

/* ── Color-by-rank: interpolate vivid → dim ── */
function rankColors(n, palette) {
  return Array.from({length:n},(_,i)=>palette[Math.min(i, palette.length-1)]);
}

/* ── Loading state ── */
function setLoading(id, msg='Loading') {
  const el = document.getElementById(id);
  el.innerHTML = `<svg class="chart-loading-hex" viewBox="0 0 40 40" fill="none"><path d="M20 3 L35 11.5 L35 28.5 L20 37 L5 28.5 L5 11.5 Z" stroke="#c9a96e" stroke-width="1.6" fill="none"/><line x1="5" y1="20" x2="35" y2="20" stroke="#c9a96e" stroke-width="1.6" opacity=".5"/></svg>${msg}`;
  el.classList.add('chart-loading');
}

let META = null;

/* ══════════════════════════════════════════════════════════════
   BOOT
   ══════════════════════════════════════════════════════════════ */
async function boot() {
  META = await fetch('/api/meta').then(r=>r.json());

  document.getElementById('pill-persons').textContent = META.stats.total_persons.toLocaleString() + ' profiles';
  document.getElementById('pill-date').textContent    = 'Updated ' + META.metadata.generated_at.slice(0,10);

  const strips = [
    [META.stats.total_persons, 'Persons Analyzed'],
    [META.stats.total_jobs,    'Job Records'],
    [META.stats.unique_roles,  'Unique Roles'],
    [META.stats.majors,        'Fields of Study'],
    [META.stats.industries,    'Industries'],
    [META.stats.target_roles,  'Career Paths Mapped'],
  ];
  const stripEl = document.getElementById('stat-strip');
  stripEl.innerHTML = strips.map(([n,l])=>`
    <div class="stat-item">
      <div class="stat-n" data-target="${n.toLocaleString()}">0</div>
      <div class="stat-l">${l}</div>
    </div>`).join('');
  setTimeout(()=>stripEl.querySelectorAll('.stat-n').forEach(el=>animateCount(el,el.dataset.target)),200);

  const files = META.metadata.data_files.join(' · ') || '—';
  document.getElementById('ov-grid').innerHTML = `
    <div class="ov-card"><div class="ov-card-accent"></div>
      <div class="ov-card-label">Dataset Scale</div>
      <div class="ov-card-title">Built on ${META.stats.total_persons.toLocaleString()} real career journeys</div>
      <div class="ov-card-desc">Sourced from Live Data Technologies, this dataset captures millions of individual role transitions, promotions, and career pivots across industries and geographies.</div>
      <div class="ov-card-nums">
        <div class="ov-num"><div class="ov-num-val">${META.stats.total_persons.toLocaleString()}</div><div class="ov-num-lbl">Profiles</div></div>
        <div class="ov-num"><div class="ov-num-val">${META.stats.total_jobs.toLocaleString()}</div><div class="ov-num-lbl">Job Records</div></div>
      </div>
    </div>
    <div class="ov-card"><div class="ov-card-accent"></div>
      <div class="ov-card-label">Role Intelligence</div>
      <div class="ov-card-title">${META.stats.unique_roles.toLocaleString()} roles mapped across the career graph</div>
      <div class="ov-card-desc">Every transition between job titles is weighted by probability. Explore where any role tends to go next, and how long each move typically takes.</div>
      <div class="ov-card-nums">
        <div class="ov-num"><div class="ov-num-val">${META.stats.unique_roles.toLocaleString()}</div><div class="ov-num-lbl">Unique Roles</div></div>
        <div class="ov-num"><div class="ov-num-val">${META.stats.target_roles.toLocaleString()}</div><div class="ov-num-lbl">Career Paths</div></div>
      </div>
    </div>
    <div class="ov-card"><div class="ov-card-accent"></div>
      <div class="ov-card-label">Education Outcomes</div>
      <div class="ov-card-title">What ${META.stats.majors.toLocaleString()} majors actually lead to</div>
      <div class="ov-card-desc">From Computer Science to Philosophy — see exactly which job titles new graduates land in and the probability distribution of those first career steps.</div>
      <div class="ov-card-nums">
        <div class="ov-num"><div class="ov-num-val">${META.stats.majors.toLocaleString()}</div><div class="ov-num-lbl">Fields of Study</div></div>
      </div>
    </div>
    <div class="ov-card"><div class="ov-card-accent"></div>
      <div class="ov-card-label">Industry Mobility</div>
      <div class="ov-card-title">Cross-sector movement across ${META.stats.industries.toLocaleString()} industries</div>
      <div class="ov-card-desc">Understand how professionals migrate between sectors — which industries retain talent and which act as stepping stones to others. Source: ${files}.</div>
      <div class="ov-card-nums">
        <div class="ov-num"><div class="ov-num-val">${META.stats.industries.toLocaleString()}</div><div class="ov-num-lbl">Industries</div></div>
      </div>
    </div>`;

  // Populate main selects
  ['role-select','major-select','ind-select','path-select'].forEach((id,i)=>{
    const lists=[META.top_roles,META.top_majors,META.top_industries,META.top_target_roles];
    const sel=document.getElementById(id);
    sel.innerHTML=lists[i].map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');
  });

  // Populate AI planner selects
  const blankOpt = '<option value="">— select —</option>';
  document.getElementById('ai-major').innerHTML = META.top_majors.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');
  document.getElementById('ai-current-role').innerHTML  = blankOpt + META.top_roles.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');
  document.getElementById('ai-current-industry').innerHTML   = blankOpt + META.top_industries.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');
  document.getElementById('ai-target-role').innerHTML  = blankOpt + META.top_target_roles.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');

  // Hide loader
  const ldr = document.getElementById('loader');
  ldr.classList.add('fade');
  setTimeout(()=>ldr.remove(), 700);

  // Populate Career Flow major select
  const flowSel = document.getElementById('flow-major-select');
  flowSel.innerHTML = '<option value="">All Majors (Overview)</option>' +
    META.top_majors.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');

  // Pre-load charts
  loadPromo();
  loadRole(META.top_roles[0]);
  loadMajor(META.top_majors[0]);
  loadInd(META.top_industries[0]);
  loadPaths(META.top_target_roles[0]);
  loadSankeyMajor('');
  loadSankeyIndustry();
}

/* ══════════════════════════════════════════════════════════════
   CHART LOADERS — each uses a distinct type & vivid palette
   ══════════════════════════════════════════════════════════════ */

/* PROMO VELOCITY → Lollipop chart (scatter + bar) */
async function loadPromo() {
  const data = await fetch('/api/promo').then(r=>r.json());
  const ents = Object.entries(data).sort((a,b)=>a[1].median_months-b[1].median_months);
  const el   = document.getElementById('chart-promo');
  el.classList.remove('chart-loading'); el.innerHTML='';

  const highConf = ents.filter(e=>!e[1].low_confidence);
  const lowConf  = ents.filter(e=>e[1].low_confidence);

  // Build lollipop: thin bars as stems + scatter dots
  const traces = [];

  // High-confidence: cyan stems
  if (highConf.length) {
    traces.push({
      type:'bar', orientation:'h',
      x: highConf.map(e=>e[1].median_months),
      y: highConf.map(e=>e[0]),
      marker:{ color:'rgba(0,229,255,0.12)', line:{width:0} },
      width: 0.08,
      name:'', showlegend:false, hoverinfo:'skip',
    });
    traces.push({
      type:'scatter', mode:'markers+text',
      x: highConf.map(e=>e[1].median_months),
      y: highConf.map(e=>e[0]),
      marker:{ color: PAL.promoHigh, size:14, line:{color:'rgba(0,229,255,0.3)',width:2}, symbol:'circle' },
      text: highConf.map(e=>`${e[1].median_months.toFixed(0)}mo`),
      textposition:'middle right', textfont:{size:11, color: TEXT2},
      name:'High confidence', hovertemplate:'<b>%{y}</b><br>%{x:.0f} months median<extra></extra>',
    });
  }

  // Low-confidence: dim teal stems
  if (lowConf.length) {
    traces.push({
      type:'bar', orientation:'h',
      x: lowConf.map(e=>e[1].median_months),
      y: lowConf.map(e=>e[0]),
      marker:{ color:'rgba(20,184,166,0.08)', line:{width:0} },
      width: 0.08,
      name:'', showlegend:false, hoverinfo:'skip',
    });
    traces.push({
      type:'scatter', mode:'markers',
      x: lowConf.map(e=>e[1].median_months),
      y: lowConf.map(e=>e[0]),
      marker:{ color:'#1e4a4a', size:10, line:{color:'#14b8a6',width:1}, symbol:'circle-open' },
      name:'Low confidence (small sample)',
      hovertemplate:'<b>%{y}</b><br>%{x:.0f} months (low confidence)<extra></extra>',
    });
  }

  Plotly.newPlot(el, traces, Object.assign({}, BASE_LAYOUT, {
    height:540,
    showlegend:true,
    barmode:'overlay',
    legend:{bgcolor:'rgba(0,0,0,0)', font:{color:TEXT2,size:11}, orientation:'h', x:0, y:1.04},
    xaxis:{...BASE_LAYOUT.xaxis, title:{text:'Median months to promotion',font:{size:11,color:TEXT3}}, gridcolor:'#1a1a1a'},
    margin:{l:8, r:100, t:48, b:44},
  }), CFG);
}

/* ROLE TRANSITIONS → Horizontal bar with cyan-to-violet gradient by rank */
async function loadRole(role) {
  if(!role) return; setLoading('chart-role');
  const data = await fetch(`/api/role/${encodeURIComponent(role)}`).then(r=>r.json());
  const p = data.transitions.slice().sort((a,b)=>a[1]-b[1]); // ascending for h-bar (bottom=highest)
  const el = document.getElementById('chart-role');
  el.classList.remove('chart-loading'); el.innerHTML='';

  const colors = rankColors(p.length, [...PAL.role].reverse()); // brightest at top

  Plotly.newPlot(el, [{
    type:'bar', orientation:'h',
    x: p.map(x=>x[1]),
    y: p.map(x=>x[0]),
    marker:{ color: colors, line:{width:0} },
    text: p.map(x=>`${(x[1]*100).toFixed(1)}%`),
    textposition:'outside',
    textfont:{size:12, color: TEXT2},
    cliponaxis:false,
    hovertemplate:'<b>%{y}</b><br>Probability: %{x:.1%}<extra></extra>',
  }], Object.assign({}, BASE_LAYOUT, {
    height:500,
    xaxis:{...BASE_LAYOUT.xaxis, tickformat:'.0%', title:{text:'Probability of transition',font:{size:11,color:TEXT3}}, gridcolor:'#1a1a1a', range:[0,p.length?p[p.length-1][1]*1.35:1]},
    title:{text:`Next roles after: ${role}`,font:{size:13,color:TEXT2},x:0.01},
  }), CFG);
}

/* MAJOR → FIRST ROLE → Funnel-style: descending bar with amber-to-rose gradient */
async function loadMajor(major) {
  if(!major) return; setLoading('chart-major');
  const data = await fetch(`/api/major/${encodeURIComponent(major)}`).then(r=>r.json());
  const p = data.roles.slice().sort((a,b)=>a[1]-b[1]); // ascending h-bar
  const el = document.getElementById('chart-major');
  el.classList.remove('chart-loading'); el.innerHTML='';

  const colors = rankColors(p.length, [...PAL.major].reverse());

  Plotly.newPlot(el, [{
    type:'bar', orientation:'h',
    x: p.map(x=>x[1]),
    y: p.map(x=>x[0]),
    marker:{
      color: colors,
      line:{width:0},
    },
    text: p.map(x=>`${(x[1]*100).toFixed(1)}%`),
    textposition:'outside',
    textfont:{size:12, color: TEXT2},
    cliponaxis:false,
    hovertemplate:'<b>%{y}</b><br>%{x:.1%} of graduates<extra></extra>',
  }], Object.assign({}, BASE_LAYOUT, {
    height:500,
    xaxis:{...BASE_LAYOUT.xaxis, tickformat:'.0%', title:{text:'% of graduates who land this role first',font:{size:11,color:TEXT3}}, gridcolor:'#1a1a1a'},
    title:{text:`First roles for: ${major}`,font:{size:13,color:TEXT2},x:0.01},
  }), CFG);
}

/* INDUSTRY TRANSITIONS → Donut chart with teal-to-indigo spectrum */
async function loadInd(ind) {
  if(!ind) return; setLoading('chart-ind');
  const data = await fetch(`/api/industry/${encodeURIComponent(ind)}`).then(r=>r.json());
  const p = data.destinations.slice().sort((a,b)=>b[1]-a[1]);
  const el = document.getElementById('chart-ind');
  el.classList.remove('chart-loading'); el.innerHTML='';

  Plotly.newPlot(el, [{
    type:'pie',
    hole: 0.52,
    values: p.map(x=>x[1]),
    labels: p.map(x=>x[0]),
    marker:{
      colors: PAL.industry.slice(0, p.length),
      line:{color: BG, width:2},
    },
    textinfo:'label+percent',
    textfont:{size:11, color: TEXT1},
    insidetextorientation:'auto',
    hovertemplate:'<b>%{label}</b><br>%{percent}<br>(%{value:.1%} of transitions)<extra></extra>',
    direction:'clockwise',
    sort:false,
  }], {
    paper_bgcolor: BG,
    plot_bgcolor: BG,
    font:{family:"'Inter',sans-serif", color:TEXT2, size:12},
    height:500,
    margin:{l:20, r:20, t:48, b:20},
    showlegend:true,
    legend:{
      bgcolor:'rgba(0,0,0,0)', font:{color:TEXT2,size:11},
      orientation:'v', x:1.02, y:0.5,
    },
    title:{text:`Where professionals leave ${ind}`,font:{size:13,color:TEXT2},x:0.01},
    annotations:[{
      text:`<b style="font-size:13px">${ind}</b><br><span style="font-size:10px;color:${TEXT3}">Origin</span>`,
      x:0.5, y:0.5, xref:'paper', yref:'paper',
      showarrow:false,
      font:{size:12, color:TEXT1},
      align:'center',
    }],
  }, CFG);
}

/* CAREER FLOW — Sankey: Major → First Role */
const SANKEY_COLORS = [
  '#06b6d4','#a855f7','#f59e0b','#22c55e','#f43f5e',
  '#3b82f6','#ec4899','#14b8a6','#eab308','#8b5cf6',
  '#0ea5e9','#f97316','#10b981','#6366f1','#db2777',
  '#84cc16','#ef4444','#7c3aed','#fbbf24','#4c1d95'
];

async function loadSankeyMajor(major) {
  setLoading('chart-sankey-major');
  const url = major ? `/api/sankey/major?major=${encodeURIComponent(major)}` : '/api/sankey/major';
  const data = await fetch(url).then(r=>r.json());
  const el = document.getElementById('chart-sankey-major');
  el.classList.remove('chart-loading'); el.innerHTML='';
  if(!data.nodes||!data.nodes.length){
    el.innerHTML=`<div style="padding:40px;color:${TEXT3};font-size:12px;text-align:center;">No data for this major.</div>`;
    return;
  }
  const nodeColors = data.nodes.map((_,i)=>SANKEY_COLORS[i % SANKEY_COLORS.length]);
  const linkColors = data.links.map(l=>{
    const c = SANKEY_COLORS[l.source % SANKEY_COLORS.length];
    // Make link semi-transparent version of source color
    const r=parseInt(c.slice(1,3),16),g=parseInt(c.slice(3,5),16),b=parseInt(c.slice(5,7),16);
    return `rgba(${r},${g},${b},0.35)`;
  });
  Plotly.newPlot(el, [{
    type:'sankey',
    orientation:'h',
    node:{
      pad:18, thickness:22, line:{color:BG, width:1},
      label: data.nodes,
      color: nodeColors,
      hovertemplate:'<b>%{label}</b><extra></extra>',
    },
    link:{
      source: data.links.map(l=>l.source),
      target: data.links.map(l=>l.target),
      value:  data.links.map(l=>l.value),
      color:  linkColors,
      hovertemplate:'%{source.label} → %{target.label}<br>Volume: %{value}<extra></extra>',
    },
  }], {
    paper_bgcolor: BG, plot_bgcolor: BG,
    font:{family:"'Inter',sans-serif", color:TEXT2, size:12},
    height:520,
    margin:{l:24, r:24, t:48, b:24},
    title:{text: data.title||'Major → First Role', font:{size:13,color:TEXT2}, x:0.01},
  }, CFG);
}

async function loadSankeyIndustry() {
  setLoading('chart-sankey-industry');
  const data = await fetch('/api/sankey/industry').then(r=>r.json());
  const el = document.getElementById('chart-sankey-industry');
  el.classList.remove('chart-loading'); el.innerHTML='';
  if(!data.nodes||!data.nodes.length){
    el.innerHTML=`<div style="padding:40px;color:${TEXT3};font-size:12px;text-align:center;">No data.</div>`;
    return;
  }
  const nodeColors = data.nodes.map((_,i)=>SANKEY_COLORS[i % SANKEY_COLORS.length]);
  const linkColors = data.links.map(l=>{
    const c = SANKEY_COLORS[l.source % SANKEY_COLORS.length];
    const r=parseInt(c.slice(1,3),16),g=parseInt(c.slice(3,5),16),b=parseInt(c.slice(5,7),16);
    return `rgba(${r},${g},${b},0.3)`;
  });
  Plotly.newPlot(el, [{
    type:'sankey',
    orientation:'h',
    node:{
      pad:18, thickness:22, line:{color:BG, width:1},
      label: data.nodes,
      color: nodeColors,
      hovertemplate:'<b>%{label}</b><extra></extra>',
    },
    link:{
      source: data.links.map(l=>l.source),
      target: data.links.map(l=>l.target),
      value:  data.links.map(l=>l.value),
      color:  linkColors,
      hovertemplate:'%{source.label} → %{target.label}<br>Volume: %{value}<extra></extra>',
    },
  }], {
    paper_bgcolor: BG, plot_bgcolor: BG,
    font:{family:"'Inter',sans-serif", color:TEXT2, size:12},
    height:520,
    margin:{l:24, r:24, t:48, b:24},
    title:{text:'Industry → Industry Transfers', font:{size:13,color:TEXT2}, x:0.01},
  }, CFG);
}

/* CAREER PATHS → stays as cards (non-chart) */
async function loadPaths(role) {
  if(!role) return;
  const data = await fetch(`/api/paths/${encodeURIComponent(role)}`).then(r=>r.json());
  const list = document.getElementById('paths-list');
  if(!data.paths.length){
    list.innerHTML=`<div style="padding:40px 28px;color:${TEXT3};font-size:13px;">No data for this role.</div>`;
    return;
  }
  list.innerHTML = data.paths.map((entry,i)=>{
    const deduped=[]; let count=1;
    for(let j=0;j<entry.path.length;j++){
      if(j>0&&entry.path[j]===entry.path[j-1]){count++;deduped[deduped.length-1].count=count;}
      else{count=1;deduped.push({step:entry.path[j],count:1});}
    }
    // Color each chip differently in the path
    const chipColors = ['#06b6d4','#a855f7','#f59e0b','#22c55e','#f43f5e'];
    const chips=deduped.map((d,j)=>{
      const badge=d.count>1?` <span style="font-size:10px;color:var(--gold);opacity:.7;">x${d.count}</span>`:'';
      const arr=j<deduped.length-1?`<span class="chip-arr">&#8594;</span>`:'';
      const c = chipColors[j % chipColors.length];
      return `<span class="chip" style="border-color:${c}33;background:${c}0d;color:${c}">${d.step}${badge}</span>${arr}`;
    }).join('');
    return `<div class="path-row"><div class="path-idx">${i+1}</div><div class="path-chips">${chips}</div><div class="path-vol">${entry.frequency.toLocaleString()}</div></div>`;
  }).join('');
}

/* ══════════════════════════════════════════════════════════════
   TAB WIRING
   ══════════════════════════════════════════════════════════════ */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
    setTimeout(()=>window.dispatchEvent(new Event('resize')),60);
  });
});

document.querySelectorAll('.plan-tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.plan-tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.plan-pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('ptab-'+btn.dataset.ptab).classList.add('active');
    setTimeout(()=>window.dispatchEvent(new Event('resize')),60);
  });
});

/* ── Search wiring ── */
function wire(searchId,selectId,list,loader){
  const inp=document.getElementById(searchId), sel=document.getElementById(selectId);
  inp.addEventListener('input',()=>{ const v=filterSelect(sel,list(),inp.value); if(v)loader(v); });
  sel.addEventListener('change',()=>loader(sel.value));
}

boot().then(()=>{
  wire('role-search','role-select',()=>META.top_roles,loadRole);
  wire('major-search','major-select',()=>META.top_majors,loadMajor);
  wire('ind-search','ind-select',()=>META.top_industries,loadInd);
  wire('path-search','path-select',()=>META.top_target_roles,loadPaths);

  // Career Flow wiring
  const fmSearch = document.getElementById('flow-major-search');
  const fmSelect = document.getElementById('flow-major-select');
  fmSearch.addEventListener('input', ()=>{
    const q = fmSearch.value.trim().toLowerCase();
    const all = META.top_majors;
    const filt = q ? [...all.filter(o=>o.toLowerCase().startsWith(q)), ...all.filter(o=>!o.toLowerCase().startsWith(q)&&o.toLowerCase().includes(q))] : all;
    const prev = fmSelect.value;
    fmSelect.innerHTML = '<option value="">All Majors (Overview)</option>' + filt.map(o=>`<option value="${o.replace(/"/g,'&quot;')}">${o}</option>`).join('');
    if(filt.includes(prev)) fmSelect.value = prev;
    loadSankeyMajor(fmSelect.value);
  });
  fmSelect.addEventListener('change', ()=>loadSankeyMajor(fmSelect.value));
});

/* ══════════════════════════════════════════════════════════════
   AI PLANNER
   ══════════════════════════════════════════════════════════════ */
let PLAN_JSON = '';
let PLAN_MONTHS = 12;

function setStatus(text, state='idle') {
  const dot  = document.getElementById('status-dot');
  const span = document.getElementById('status-text');
  span.textContent = text;
  dot.className = 'status-dot' + (state==='active'?' active':state==='done'?' done':state==='error'?' error':'');
}

function md2html(md) {
  return md
    .replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    .replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>')
    .replace(/^---$/gm,'<hr/>')
    .replace(/^\d+\. (.+)$/gm,'<li>$1</li>')
    .replace(/^[-*] (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g,m=>`<ul>${m}</ul>`)
    .replace(/\n\n+/g,'</p><p>')
    .replace(/^(?!<[huplbci])(.+)$/gm,'<p>$1</p>')
    .replace(/<p><\/p>/g,'');
}

async function generatePlan() {
  const btn = document.getElementById('generate-btn');
  btn.disabled = true;
  setStatus('Analyzing your profile against 75,000+ real career trajectories...', 'active');

  const profile = {
    major:            document.getElementById('ai-major').value,
    current_role:     document.getElementById('ai-current-role').value,
    current_industry: document.getElementById('ai-current-industry').value,
    target_role:      document.getElementById('ai-target-role').value,
    years_exp:        document.getElementById('ai-years').value,
    months_to_graduation: document.getElementById('ai-months').value,
    skills:           document.getElementById('ai-skills').value,
    gpa:              document.getElementById('ai-gpa').value,
    location_pref:    document.getElementById('ai-location').value,
    work_style:       document.querySelector('input[name=work_style]:checked')?.value || 'No preference',
    urgency:          document.querySelector('input[name=urgency]:checked')?.value || 'Actively planning',
    internships:      document.getElementById('ai-internships').value,
    salary_expectations: document.getElementById('ai-salary').value,
    constraints:      document.getElementById('ai-constraints').value,
    extra:            document.getElementById('ai-extra').value,
  };
  PLAN_MONTHS = parseInt(profile.months_to_graduation) || 12;

  try {
    setStatus('Generating your personalized plan — this may take 15–30 seconds...', 'active');
    const res = await fetch('/api/planner/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(profile),
    });

    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Server error');
    }

    const data = await res.json();
    const plan = data.plan;
    const sup  = data.supporting;
    PLAN_JSON  = JSON.stringify(plan);

    // Render roadmap markdown
    const target   = profile.target_role || 'your target role';
    const mdLines  = [
      `# Your Personalized Career Roadmap`,
      `**Goal:** ${target} &nbsp;|&nbsp; **Timeline:** ${PLAN_MONTHS} months\n`,
      `> ${plan.summary || ''}\n`,
      `## Where You Stand`,
      (plan.where_i_stand || '') + '\n',
      `## Key Gaps to Close`,
      ...(plan.gap_analysis||[]).map(g=>`- ${g}`),
      '\n## Month-by-Month Milestones',
      ...(plan.milestones||[]).flatMap(m=>[
        `### Month ${m.month} — ${m.title} \`[${m.category}]\``,
        `**Action:** ${m.action}`,
        `**Done when:** ${m.success_metric}\n`,
      ]),
      `## Quick Wins (Next 90 Days)`,
      ...(plan.quick_wins||[]).map((w,i)=>`${i+1}. ${w}`),
      '\n## Risks & Watch-Outs',
      ...(plan.risks||[]).map(r=>`- ${r}`),
      '\n## Salary Trajectory',
      (plan.salary_trajectory||'') + '\n',
      `## What the Real Data Says`,
      (plan.data_insights||'') + '\n',
      '---',
      '*Generated by SkillShock AI · Gemini 2.5 Flash · 75,000+ real career trajectories*',
    ].join('\n');

    document.getElementById('plan-md-content').innerHTML = md2html(mdLines);

    /* ── Plan sub-charts — also vivid + distinct types ── */

    // Role transitions: cyan horizontal bars
    function plotPlanRole(id, pairs) {
      const el = document.getElementById(id);
      el.classList.remove('chart-loading'); el.innerHTML='';
      if(!pairs||!pairs.length){
        el.innerHTML=`<div style="padding:40px;color:${TEXT3};font-size:12px;text-align:center;">No data.</div>`; return;
      }
      const rev=[...pairs].reverse();
      const colors = rankColors(rev.length, [...PAL.planRole]);
      Plotly.newPlot(el,[{
        type:'bar', orientation:'h',
        x:rev.map(p=>Array.isArray(p)?p[1]:p.months||0),
        y:rev.map(p=>Array.isArray(p)?p[0]:p.label||''),
        marker:{color:colors, line:{width:0}},
        text:rev.map(p=>{const v=Array.isArray(p)?p[1]:p.months||0; return typeof v==='number'&&v<2?`${(v*100).toFixed(1)}%`:`${v.toFixed?v.toFixed(0):v}`;}),
        textposition:'outside', textfont:{size:10,color:TEXT2}, cliponaxis:false,
        hovertemplate:'<b>%{y}</b><br>%{x:.1%}<extra></extra>',
      }],Object.assign({},BASE_LAYOUT,{height:280,margin:{l:4,r:80,t:16,b:24},xaxis:{...BASE_LAYOUT.xaxis,tickformat:'.0%'}}),CFG);
    }

    // Major first roles: amber/rose horizontal bars
    function plotPlanMajor(id, pairs) {
      const el = document.getElementById(id);
      el.classList.remove('chart-loading'); el.innerHTML='';
      if(!pairs||!pairs.length){
        el.innerHTML=`<div style="padding:40px;color:${TEXT3};font-size:12px;text-align:center;">No data.</div>`; return;
      }
      const rev=[...pairs].reverse();
      const colors = rankColors(rev.length, [...PAL.planMajor]);
      Plotly.newPlot(el,[{
        type:'bar', orientation:'h',
        x:rev.map(p=>Array.isArray(p)?p[1]:p.months||0),
        y:rev.map(p=>Array.isArray(p)?p[0]:p.label||''),
        marker:{color:colors, line:{width:0}},
        text:rev.map(p=>{const v=Array.isArray(p)?p[1]:p.months||0; return `${(v*100).toFixed(1)}%`;}),
        textposition:'outside', textfont:{size:10,color:TEXT2}, cliponaxis:false,
      }],Object.assign({},BASE_LAYOUT,{height:280,margin:{l:4,r:80,t:16,b:24},xaxis:{...BASE_LAYOUT.xaxis,tickformat:'.0%'}}),CFG);
    }

    // Industry: mini-donut
    function plotPlanIndustry(id, pairs) {
      const el = document.getElementById(id);
      el.classList.remove('chart-loading'); el.innerHTML='';
      if(!pairs||!pairs.length){
        el.innerHTML=`<div style="padding:40px;color:${TEXT3};font-size:12px;text-align:center;">No data.</div>`; return;
      }
      const sorted=[...pairs].sort((a,b)=>(Array.isArray(b)?b[1]:b.months||0)-(Array.isArray(a)?a[1]:a.months||0));
      Plotly.newPlot(el,[{
        type:'pie', hole:0.45,
        values:sorted.map(p=>Array.isArray(p)?p[1]:p.months||0),
        labels:sorted.map(p=>Array.isArray(p)?p[0]:p.label||''),
        marker:{colors:PAL.planInd.slice(0,sorted.length), line:{color:BG,width:2}},
        textinfo:'label+percent', textfont:{size:9,color:TEXT1},
        hovertemplate:'<b>%{label}</b><br>%{percent}<extra></extra>',
        direction:'clockwise', sort:false,
      }],{
        paper_bgcolor:BG, plot_bgcolor:BG,
        font:{family:"'Inter',sans-serif",color:TEXT2,size:10},
        height:280, margin:{l:8,r:8,t:16,b:8},
        showlegend:false,
      },CFG);
    }

    plotPlanRole('plan-chart-role', sup.role_transitions);
    plotPlanMajor('plan-chart-major', sup.major_first_roles);
    plotPlanIndustry('plan-chart-industry', sup.industry_destinations);

    // Promo chart: lollipop with highlighted
    const promoEl = document.getElementById('plan-chart-promo');
    promoEl.classList.remove('chart-loading'); promoEl.innerHTML='';
    const pdata = sup.promo_velocity;
    if(pdata&&pdata.length){
      const rel = pdata.filter(p=>p.relevant);
      const high = pdata.filter(p=>!p.relevant&&!p.low_confidence);
      const low  = pdata.filter(p=>p.low_confidence);
      const traces = [];
      if(rel.length) traces.push({
        type:'scatter',mode:'markers+text',
        x:rel.map(p=>p.months), y:rel.map(p=>p.label),
        marker:{color:'#f59e0b',size:16,line:{color:'#fbbf24',width:2},symbol:'star'},
        text:rel.map(p=>`${p.months.toFixed(0)}mo`),
        textposition:'middle right',textfont:{size:10,color:'#fbbf24'},
        name:'Your Path',
        hovertemplate:'<b>%{y}</b><br>%{x:.0f} months ⭐ Your path<extra></extra>',
      });
      if(high.length) traces.push({
        type:'scatter',mode:'markers',
        x:high.map(p=>p.months), y:high.map(p=>p.label),
        marker:{color:PAL.promoHigh,size:10,line:{color:'rgba(0,229,255,0.3)',width:1}},
        name:'High Confidence',
        hovertemplate:'<b>%{y}</b><br>%{x:.0f} months<extra></extra>',
      });
      if(low.length) traces.push({
        type:'scatter',mode:'markers',
        x:low.map(p=>p.months), y:low.map(p=>p.label),
        marker:{color:PAL.promoDim,size:8,line:{color:'#14b8a6',width:1},symbol:'circle-open'},
        name:'Low Confidence',
        hovertemplate:'<b>%{y}</b><br>%{x:.0f} months (low sample)<extra></extra>',
      });
      Plotly.newPlot(promoEl,traces,Object.assign({},BASE_LAYOUT,{
        height:280,showlegend:true,
        margin:{l:4,r:80,t:24,b:24},
        legend:{bgcolor:'rgba(0,0,0,0)',font:{color:TEXT2,size:9},orientation:'h',x:0,y:1.1},
        xaxis:{...BASE_LAYOUT.xaxis,title:{text:'Months',font:{size:10,color:TEXT3}}},
      }),CFG);
    }

    // Career paths in plan
    const pathsEl = document.getElementById('plan-paths-content');
    const pathData = sup.paths_to_target;
    const chipColors = ['#06b6d4','#a855f7','#f59e0b','#22c55e','#f43f5e'];
    if(!pathData||!pathData.length){
      pathsEl.innerHTML=`<p style="color:${TEXT3};font-size:13px;">No career path data found for the target role.</p>`;
    } else {
      pathsEl.innerHTML = pathData.map((entry,i)=>{
        const chips = entry.path.map((s,j)=>{
          const c = chipColors[j % chipColors.length];
          return `<span class="chip" style="border-color:${c}33;background:${c}0d;color:${c}">${s}</span>${j<entry.path.length-1?'<span class="chip-arr">→</span>':''}`;
        }).join('');
        return `<div class="plan-path-row"><div class="plan-path-idx">${i+1}</div><div class="plan-path-chips">${chips}</div><div class="plan-path-vol">${entry.frequency.toLocaleString()}</div></div>`;
      }).join('');
    }

    // Timeline / Gantt
    const milestones = plan.milestones||[];
    const timelineEl = document.getElementById('plan-chart-timeline');
    timelineEl.classList.remove('chart-loading'); timelineEl.innerHTML='';
    if(milestones.length){
      const traces=[]; const seen=new Set();
      milestones.forEach((m,i)=>{
        const cat=m.category||'Skills', color=PAL.gantt[cat]||GOLD;
        const label=`M${m.month}: ${m.title}`;
        traces.push({
          type:'bar', orientation:'h',
          x:[0.8], y:[label], base:[m.month-0.4],
          marker:{
            color:color,
            opacity:0.85,
            line:{color:BG, width:1},
          },
          name:cat, legendgroup:cat, showlegend:!seen.has(cat),
          hovertemplate:`<b>Month ${m.month}: ${m.title}</b><br>Category: ${cat}<br>Action: ${m.action}<br>Done: ${m.success_metric}<extra></extra>`,
          text:[m.title], textposition:'inside', insidetextanchor:'middle',
          textfont:{size:10, color:'rgba(0,0,0,0.8)', family:"'Inter',sans-serif"},
        });
        seen.add(cat);
      });
      Plotly.newPlot(timelineEl, traces, Object.assign({},BASE_LAYOUT,{
        title:{text:'Month-by-Month Career Roadmap',font:{size:13,color:TEXT2}},
        xaxis:{title:'Month',range:[0,PLAN_MONTHS+1],dtick:1,gridcolor:GRID,color:TEXT3},
        yaxis:{autorange:'reversed',tickfont:{size:10},color:TEXT1,showgrid:false},
        barmode:'overlay',
        height:Math.max(350,milestones.length*44),
        legend:{orientation:'h',yanchor:'bottom',y:1.02,xanchor:'left',x:0,bgcolor:'rgba(0,0,0,0)',font:{color:TEXT2,size:10}},
        margin:{l:20,r:20,t:80,b:40},
        paper_bgcolor:BG, plot_bgcolor:BG,
        showlegend:true,
      }),CFG);
    }

    document.getElementById('btn-pdf').disabled = false;
    document.getElementById('btn-ics').disabled = false;
    setStatus('Plan generated successfully.', 'done');

  } catch(err) {
    setStatus('Error: ' + err.message, 'error');
    document.getElementById('plan-md-content').innerHTML =
      `<p style="color:#f44;font-size:13px;">⚠️ ${err.message}</p>`;
  }

  btn.disabled = false;
}

async function exportPDF() {
  if(!PLAN_JSON) return;
  const profile_summary = [
    document.getElementById('ai-major').value,
    document.getElementById('ai-current-role').value,
    document.getElementById('ai-target-role').value,
  ].filter(Boolean).join(' · ') || 'SkillShock Plan';
  const res = await fetch('/api/planner/pdf', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({plan_json: PLAN_JSON, profile_summary}),
  });
  if(res.ok){
    const blob=await res.blob(); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='skillshock_plan.pdf'; a.click();
    URL.revokeObjectURL(url);
  }
}

async function exportICS() {
  if(!PLAN_JSON) return;
  const res = await fetch('/api/planner/ics', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({plan_json: PLAN_JSON, months_total: PLAN_MONTHS}),
  });
  if(res.ok){
    const blob=await res.blob(); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='skillshock_plan.ics'; a.click();
    URL.revokeObjectURL(url);
  }
}
</script>
</body>
</html>